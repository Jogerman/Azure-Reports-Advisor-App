{% extends 'reports/base.html' %}

{% block title %}Security Assessment Report - {{ client.company_name }}{% endblock %}

{% block extra_css %}
<style>
    /* Security-specific styles */
    .security-score-gauge {
        text-align: center;
        padding: 30px;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .score-value {
        font-size: 4em;
        font-weight: 300;
        line-height: 1;
        margin: 20px 0;
    }

    .score-excellent { color: #28a745; }
    .score-good { color: #17a2b8; }
    .score-fair { color: #ffc107; }
    .score-poor { color: #dc3545; }

    .risk-badge {
        display: inline-block;
        padding: 6px 16px;
        border-radius: 16px;
        font-size: 0.9em;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .risk-critical {
        background: #dc3545;
        color: #ffffff;
    }

    .risk-high {
        background: #fd7e14;
        color: #ffffff;
    }

    .risk-medium {
        background: #ffc107;
        color: #212529;
    }

    .risk-low {
        background: #28a745;
        color: #ffffff;
    }

    .security-metric-box {
        background: #ffffff;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .security-metric-box:hover {
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(0,120,212,0.15);
        transform: translateY(-2px);
    }

    .threat-card {
        background: #ffffff;
        border-left: 5px solid #dc3545;
        padding: 20px;
        margin: 15px 0;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .remediation-timeline {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }

    .timeline-box {
        padding: 25px;
        border-radius: 8px;
        text-align: center;
    }

    .timeline-immediate {
        background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
        border: 2px solid #dc3545;
    }

    .timeline-short {
        background: linear-gradient(135deg, #fff8e6 0%, #ffedd5 100%);
        border: 2px solid #fd7e14;
    }

    .timeline-medium {
        background: linear-gradient(135deg, #f0fff4 0%, #d1fae5 100%);
        border: 2px solid #28a745;
    }

    .compliance-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 6px;
        margin: 8px 0;
    }

    .compliance-icon {
        font-size: 1.5em;
    }
</style>
{% endblock %}

{% block content %}
    <!-- Security Score Overview -->
    <div class="section">
        <h2 class="section-title">üõ°Ô∏è Security Posture Assessment</h2>

        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px; align-items: start;">
            <div class="security-score-gauge">
                <div style="font-size: 1.1em; color: #666; margin-bottom: 10px;">Security Score</div>
                <div class="score-value score-{{ security_summary.posture_color }}">
                    {{ security_summary.security_score }}
                </div>
                <div style="font-size: 1.3em; font-weight: 600; color: var(--gray-800);">
                    {{ security_summary.security_posture }}
                </div>
                <div style="margin-top: 15px; font-size: 0.95em; color: #666;">
                    Based on {{ security_summary.total_issues }} security findings
                </div>
            </div>

            <div class="remediation-timeline">
                <div class="timeline-box timeline-immediate">
                    <div style="font-size: 2.5em; font-weight: 300; color: #dc3545; margin-bottom: 10px;">
                        {{ remediation_timeline.immediate }}
                    </div>
                    <div style="font-weight: 600; margin-bottom: 5px;">Immediate Action</div>
                    <div style="font-size: 0.9em; color: #666;">Critical - Within 24 hours</div>
                </div>

                <div class="timeline-box timeline-short">
                    <div style="font-size: 2.5em; font-weight: 300; color: #fd7e14; margin-bottom: 10px;">
                        {{ remediation_timeline.short_term }}
                    </div>
                    <div style="font-weight: 600; margin-bottom: 5px;">Short-term</div>
                    <div style="font-size: 0.9em; color: #666;">Medium - Within 1 week</div>
                </div>

                <div class="timeline-box timeline-medium">
                    <div style="font-size: 2.5em; font-weight: 300; color: #28a745; margin-bottom: 10px;">
                        {{ remediation_timeline.medium_term }}
                    </div>
                    <div style="font-weight: 600; margin-bottom: 5px;">Medium-term</div>
                    <div style="font-size: 0.9em; color: #666;">Low - Within 1 month</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Metrics Summary -->
    <div class="summary-stats">
        <div class="stat-card" style="border-left-color: #dc3545;">
            <div class="stat-label">Critical Issues</div>
            <div class="stat-value text-danger">{{ security_summary.critical_count }}</div>
            <div class="stat-subtitle">Require immediate attention</div>
        </div>

        <div class="stat-card" style="border-left-color: #fd7e14;">
            <div class="stat-label">Medium Priority</div>
            <div class="stat-value text-warning">{{ security_summary.medium_count }}</div>
            <div class="stat-subtitle">Address within 1 week</div>
        </div>

        <div class="stat-card" style="border-left-color: #ffc107;">
            <div class="stat-label">Low Priority</div>
            <div class="stat-value" style="color: #ffc107;">{{ security_summary.low_count }}</div>
            <div class="stat-subtitle">Address within 1 month</div>
        </div>

        <div class="stat-card" style="border-left-color: var(--primary-color);">
            <div class="stat-label">Total Security Findings</div>
            <div class="stat-value">{{ security_summary.total_issues }}</div>
            <div class="stat-subtitle">Across all resources</div>
        </div>
    </div>

    <!-- Critical Security Issues -->
    {% if critical_issues %}
    <div class="section">
        <h2 class="section-title">üö® Critical Security Issues - Immediate Action Required</h2>

        <div class="warning-box" style="border-left-color: #dc3545; background-color: #fff5f5;">
            <p><strong>‚ö†Ô∏è High Risk:</strong> These {{ critical_issues.count }} critical security issues pose significant risk to your environment and require immediate remediation to prevent potential security breaches.</p>
        </div>

        <table class="recommendation-table">
            <thead>
                <tr>
                    <th style="width: 5%;">#</th>
                    <th style="width: 45%;">Security Issue</th>
                    <th style="width: 20%;">Affected Resource</th>
                    <th style="width: 15%;">Risk Level</th>
                    <th style="width: 15%;">Action Priority</th>
                </tr>
            </thead>
            <tbody>
                {% for rec in critical_issues %}
                <tr>
                    <td><strong style="color: #dc3545;">{{ forloop.counter }}</strong></td>
                    <td>
                        <strong>{{ rec.recommendation|truncatewords:20 }}</strong>
                        {% if rec.potential_benefits %}
                        <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                            {{ rec.potential_benefits|truncatewords:15 }}
                        </div>
                        {% endif %}
                    </td>
                    <td style="font-size: 0.9em;">
                        <div style="font-weight: 600;">{{ rec.resource_name|default:"Unknown Resource"|truncatewords:3 }}</div>
                        <div style="color: #666;">{{ rec.resource_type|default:"Unknown Type"|truncatewords:3 }}</div>
                    </td>
                    <td class="text-center">
                        <span class="risk-badge risk-critical">CRITICAL</span>
                    </td>
                    <td class="text-center">
                        <span style="background: #dc3545; color: white; padding: 4px 10px; border-radius: 4px; font-weight: 600;">
                            24 Hours
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Medium Priority Security Issues -->
    {% if medium_priority %}
    <div class="section">
        <h2 class="section-title">‚ö†Ô∏è Medium Priority Security Issues</h2>

        <div class="info-box" style="border-left-color: #fd7e14;">
            <p>These {{ medium_priority.count }} security issues should be addressed within one week to maintain a strong security posture.</p>
        </div>

        <table class="recommendation-table">
            <thead>
                <tr>
                    <th style="width: 50%;">Security Issue</th>
                    <th style="width: 25%;">Affected Resource</th>
                    <th style="width: 15%;">Risk Level</th>
                    <th style="width: 10%;">Timeline</th>
                </tr>
            </thead>
            <tbody>
                {% for rec in medium_priority %}
                <tr>
                    <td>{{ rec.recommendation|truncatewords:20 }}</td>
                    <td style="font-size: 0.9em;">
                        {{ rec.resource_name|default:"Unknown Resource"|truncatewords:3 }}
                    </td>
                    <td class="text-center">
                        <span class="risk-badge risk-medium">MEDIUM</span>
                    </td>
                    <td class="text-center" style="font-size: 0.9em;">1 Week</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Security by Subscription -->
    {% if security_by_subscription %}
    <div class="section">
        <h2 class="section-title">üìä Security Issues by Azure Subscription</h2>

        <table class="recommendation-table">
            <thead>
                <tr>
                    <th>Subscription</th>
                    <th style="text-align: center;">Critical</th>
                    <th style="text-align: center;">Medium</th>
                    <th style="text-align: center;">Low</th>
                    <th style="text-align: center;">Total</th>
                </tr>
            </thead>
            <tbody>
                {% for sub in security_by_subscription %}
                <tr>
                    <td><strong>{{ sub.subscription_name|default:"Unknown Subscription"|truncatewords:5 }}</strong></td>
                    <td class="text-center">
                        <span class="badge badge-danger">{{ sub.critical_count }}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge badge-warning">{{ sub.medium_count }}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge" style="background: #ffc107;">{{ sub.low_count }}</span>
                    </td>
                    <td class="text-center"><strong>{{ sub.total_count }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Security by Resource Type -->
    {% if security_by_resource_type %}
    <div class="section">
        <h2 class="section-title">üîß Most Vulnerable Resource Types</h2>

        <p class="section-description">
            Focus remediation efforts on these resource types with the highest number of security findings.
        </p>

        <table class="recommendation-table">
            <thead>
                <tr>
                    <th>Resource Type</th>
                    <th style="text-align: center;">Critical Issues</th>
                    <th style="text-align: center;">Total Issues</th>
                    <th style="text-align: center;">Risk Distribution</th>
                </tr>
            </thead>
            <tbody>
                {% for resource in security_by_resource_type %}
                <tr>
                    <td><strong>{{ resource.resource_type|truncatewords:4 }}</strong></td>
                    <td class="text-center">
                        <span class="badge badge-danger">{{ resource.critical_count }}</span>
                    </td>
                    <td class="text-center"><strong>{{ resource.count }}</strong></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="flex: 1; background-color: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                                {% widthratio resource.critical_count resource.count 100 as critical_pct %}
                                <div style="width: {{ critical_pct }}%; background-color: #dc3545; height: 100%;"></div>
                            </div>
                            <span style="font-size: 0.9em;">{{ critical_pct }}% Critical</span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- All Security Recommendations -->
    <div class="section">
        <h2 class="section-title">üìã Complete Security Assessment Details</h2>

        <p class="section-description">
            Comprehensive list of all security recommendations with remediation guidance and compliance implications.
        </p>

        {% for rec in security_recommendations %}
        <div class="threat-card" style="border-left-color: {% if rec.business_impact == 'high' %}#dc3545{% elif rec.business_impact == 'medium' %}#fd7e14{% else %}#ffc107{% endif %};">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: #1a1a1a;">
                        {{ rec.recommendation }}
                    </h3>
                    <div style="display: flex; gap: 15px; font-size: 0.9em; color: #666; flex-wrap: wrap;">
                        <span><strong>Resource:</strong> {{ rec.resource_name|default:"Unknown Resource"|truncatewords:5 }}</span>
                        <span><strong>Type:</strong> {{ rec.resource_type|default:"Unknown Type"|truncatewords:3 }}</span>
                        {% if rec.resource_group %}
                        <span><strong>Resource Group:</strong> {{ rec.resource_group }}</span>
                        {% endif %}
                    </div>
                </div>
                <div style="text-align: right;">
                    {% if rec.business_impact == 'high' %}
                        <span class="risk-badge risk-critical">CRITICAL</span>
                    {% elif rec.business_impact == 'medium' %}
                        <span class="risk-badge risk-medium">MEDIUM</span>
                    {% else %}
                        <span class="risk-badge risk-low">LOW</span>
                    {% endif %}
                </div>
            </div>

            {% if rec.potential_benefits %}
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 10px 0;">
                <strong style="color: #28a745;">‚úì Security Benefits:</strong>
                <p style="margin: 8px 0 0 0;">{{ rec.potential_benefits }}</p>
            </div>
            {% endif %}

            <div style="display: flex; gap: 20px; font-size: 0.85em; color: #666; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                <span><strong>Subscription:</strong> {{ rec.subscription_name|default:rec.subscription_id|truncatewords:4 }}</span>
                <span><strong>Priority:</strong>
                    {% if rec.business_impact == 'high' %}
                        <span style="color: #dc3545; font-weight: 600;">Immediate (24h)</span>
                    {% elif rec.business_impact == 'medium' %}
                        <span style="color: #fd7e14; font-weight: 600;">Short-term (1 week)</span>
                    {% else %}
                        <span style="color: #ffc107; font-weight: 600;">Medium-term (1 month)</span>
                    {% endif %}
                </span>
            </div>
        </div>
        {% empty %}
        <div class="success-box">
            <h3 style="color: #28a745; margin-bottom: 10px;">‚úÖ Excellent Security Posture!</h3>
            <p>No security recommendations found. Your Azure environment is following security best practices.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Compliance & Standards -->
    <div class="section">
        <h2 class="section-title">üìú Compliance Considerations</h2>

        <div class="info-box">
            <h3 style="margin-bottom: 15px;">Regulatory Framework Alignment</h3>
            <p style="margin-bottom: 20px;">
                Addressing these security recommendations helps maintain compliance with common security frameworks and standards:
            </p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div class="compliance-indicator">
                    <div class="compliance-icon">üîí</div>
                    <div>
                        <strong>ISO 27001</strong>
                        <div style="font-size: 0.9em; color: #666;">Information Security Management</div>
                    </div>
                </div>

                <div class="compliance-indicator">
                    <div class="compliance-icon">üõ°Ô∏è</div>
                    <div>
                        <strong>NIST CSF</strong>
                        <div style="font-size: 0.9em; color: #666;">Cybersecurity Framework</div>
                    </div>
                </div>

                <div class="compliance-indicator">
                    <div class="compliance-icon">üìã</div>
                    <div>
                        <strong>CIS Controls</strong>
                        <div style="font-size: 0.9em; color: #666;">Critical Security Controls</div>
                    </div>
                </div>

                <div class="compliance-indicator">
                    <div class="compliance-icon">üîê</div>
                    <div>
                        <strong>SOC 2</strong>
                        <div style="font-size: 0.9em; color: #666;">Trust Service Principles</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Remediation Roadmap -->
    <div class="section">
        <h2 class="section-title">üó∫Ô∏è Security Remediation Roadmap</h2>

        <div class="warning-box">
            <h3 style="margin-bottom: 15px;">Recommended Remediation Phases</h3>

            <div style="margin-top: 20px;">
                <h4 style="color: #dc3545; margin-bottom: 15px;">Phase 1: Critical Response (24 Hours)</h4>
                <ul style="line-height: 2;">
                    <li>Address all {{ security_summary.critical_count }} critical security issues immediately</li>
                    <li>Implement temporary mitigations if permanent fixes require more time</li>
                    <li>Document all changes and validate effectiveness</li>
                    <li>Notify security team and stakeholders of actions taken</li>
                </ul>

                <h4 style="color: #fd7e14; margin-top: 25px; margin-bottom: 15px;">Phase 2: Short-term Hardening (Week 1)</h4>
                <ul style="line-height: 2;">
                    <li>Remediate all {{ security_summary.medium_count }} medium-priority security issues</li>
                    <li>Review and update security policies and procedures</li>
                    <li>Conduct security awareness training for affected teams</li>
                    <li>Implement additional monitoring and alerting</li>
                </ul>

                <h4 style="color: #28a745; margin-top: 25px; margin-bottom: 15px;">Phase 3: Continuous Improvement (Month 1)</h4>
                <ul style="line-height: 2;">
                    <li>Address all {{ security_summary.low_count }} low-priority findings</li>
                    <li>Implement security automation and guardrails</li>
                    <li>Establish regular Azure Advisor security reviews</li>
                    <li>Create security metrics dashboard and KPIs</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Next Steps -->
    <div class="section">
        <h2 class="section-title">‚úÖ Immediate Next Steps</h2>

        <div class="success-box">
            <ol style="line-height: 2.2; font-size: 1.05em;">
                <li><strong>Triage Critical Issues:</strong> Convene security team to review all critical findings within 2 hours</li>
                <li><strong>Assign Ownership:</strong> Designate owners for each security issue with clear accountability</li>
                <li><strong>Implement Quick Wins:</strong> Address any findings that can be resolved with minimal effort immediately</li>
                <li><strong>Create Remediation Tickets:</strong> Log all findings in your ticketing system with appropriate priority</li>
                <li><strong>Establish Communication:</strong> Set up status updates to stakeholders on remediation progress</li>
                <li><strong>Document Changes:</strong> Maintain audit trail of all security improvements for compliance</li>
                <li><strong>Schedule Follow-up:</strong> Plan weekly security reviews until all critical issues are resolved</li>
            </ol>
        </div>
    </div>

    <!-- Security Best Practices -->
    <div class="section" style="margin-top: 40px;">
        <h2 class="section-title">üí° Security Best Practices</h2>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #0078D4;">
                <h4 style="color: #0078D4; margin-bottom: 10px;">üîÑ Continuous Monitoring</h4>
                <p style="font-size: 0.95em; line-height: 1.6;">
                    Enable Azure Security Center and review Azure Advisor recommendations weekly to catch new security issues early.
                </p>
            </div>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
                <h4 style="color: #28a745; margin-bottom: 10px;">üõ°Ô∏è Defense in Depth</h4>
                <p style="font-size: 0.95em; line-height: 1.6;">
                    Implement multiple layers of security controls: network, identity, application, and data protection.
                </p>
            </div>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
                <h4 style="color: #dc3545; margin-bottom: 10px;">üîê Zero Trust Model</h4>
                <p style="font-size: 0.95em; line-height: 1.6;">
                    Verify explicitly, use least privilege access, and assume breach when designing security architecture.
                </p>
            </div>
        </div>
    </div>

    <!-- Disclaimer -->
    <div class="section" style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
        <p style="font-size: 0.9em; color: #666; font-style: italic;">
            <strong>Important Security Notice:</strong> This security assessment is based on Azure Advisor recommendations and represents
            identified security findings at the time of report generation. It does not constitute a comprehensive security audit or
            penetration test. Organizations should conduct regular security assessments, implement defense-in-depth strategies, and
            maintain continuous security monitoring. Always validate recommendations in a test environment before implementing in production.
            For critical security concerns, consult with qualified security professionals and consider engaging third-party security assessors.
        </p>
    </div>
{% endblock %}
