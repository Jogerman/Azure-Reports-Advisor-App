{% extends 'reports/base.html' %}
{% load report_filters %}

{% block title %}Security Assessment Report - {{ client.company_name }}{% endblock %}

{% block extra_css %}
<style>
    /* Security Score Gauge */
    .security-score-container {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto;
    }

    .security-score-gauge {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: conic-gradient(
            var(--success-green) 0deg,
            var(--success-green) calc(var(--score-percentage) * 3.6deg),
            var(--gray-200) calc(var(--score-percentage) * 3.6deg),
            var(--gray-200) 360deg
        );
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .security-score-inner {
        width: 140px;
        height: 140px;
        background: white;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .security-score-value {
        font-size: 3em;
        font-weight: 700;
        line-height: 1;
    }

    .security-score-label {
        font-size: 0.9em;
        color: var(--gray-600);
        margin-top: 5px;
    }

    .risk-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 700;
        text-transform: uppercase;
    }

    .risk-critical {
        background: linear-gradient(135deg, #D13438 0%, #F25022 100%);
        color: white;
        box-shadow: 0 2px 6px rgba(209, 52, 56, 0.4);
    }

    .risk-high {
        background: linear-gradient(135deg, #FF8C00 0%, #FFB900 100%);
        color: white;
        box-shadow: 0 2px 6px rgba(255, 140, 0, 0.4);
    }

    .risk-medium {
        background: linear-gradient(135deg, #FFB900 0%, #9FDA3A 100%);
        color: var(--gray-900);
        box-shadow: 0 2px 6px rgba(255, 185, 0, 0.3);
    }

    .risk-low {
        background: linear-gradient(135deg, #9FDA3A 0%, #107C10 100%);
        color: white;
        box-shadow: 0 2px 6px rgba(16, 124, 16, 0.3);
    }

    .compliance-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 18px;
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        border: 2px solid var(--gray-300);
        font-size: 0.95em;
    }

    .compliance-icon {
        font-size: 1.5em;
    }

    .threat-severity-bar {
        display: flex;
        gap: 5px;
        align-items: center;
    }

    .severity-block {
        width: 20px;
        height: 20px;
        border-radius: 3px;
    }

    .severity-critical { background: var(--danger-red); }
    .severity-high { background: var(--warning-orange); }
    .severity-medium { background: var(--warning-yellow); }
    .severity-low { background: var(--success-green); }
    .severity-empty { background: var(--gray-200); }
</style>
{% endblock %}

{% block content %}
    <!-- Security Posture Overview -->
    <div class="executive-summary">
        <div class="summary-header">
            <h2 class="summary-title">Security Posture Assessment</h2>
            <p class="summary-subtitle">Comprehensive security analysis and vulnerability remediation roadmap</p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 40px; align-items: center; margin: 40px 0;">
            <!-- Security Score Gauge -->
            <div style="text-align: center;">
                <div class="security-score-container" style="--score-percentage: {{ security_score|default:75 }};">
                    <div class="security-score-gauge">
                        <div class="security-score-inner">
                            <div class="security-score-value" style="color: {% if security_score >= 80 %}var(--success-green){% elif security_score >= 60 %}var(--warning-orange){% else %}var(--danger-red){% endif %}">
                                {{ security_score|default:75|intcomma }}
                            </div>
                            <div class="security-score-label">Security Score</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px; font-size: 1.2em; font-weight: 600; color: var(--gray-800);">
                    {% if security_score >= 80 %}Excellent{% elif security_score >= 60 %}Good{% elif security_score >= 40 %}Fair{% else %}Needs Improvement{% endif %}
                </div>
                <div style="margin-top: 10px; color: var(--gray-600);">
                    Based on {{ total_security_findings|intcomma }} security findings
                </div>
            </div>

            <!-- Remediation Timeline -->
            <div class="metrics-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="metric-card metric-critical">
                    <div class="metric-icon">üö®</div>
                    <div class="metric-label">Immediate</div>
                    <div class="metric-value">{{ critical_count|intcomma }}</div>
                    <div class="metric-subtitle">Within 24 hours</div>
                </div>

                <div class="metric-card metric-security">
                    <div class="metric-icon">‚ö†Ô∏è</div>
                    <div class="metric-label">Short-term</div>
                    <div class="metric-value">{{ high_count|intcomma }}</div>
                    <div class="metric-subtitle">Within 1 week</div>
                </div>

                <div class="metric-card metric-cost">
                    <div class="metric-icon">üìã</div>
                    <div class="metric-label">Medium-term</div>
                    <div class="metric-value">{{ medium_count|intcomma }}</div>
                    <div class="metric-subtitle">Within 1 month</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Metrics Dashboard -->
    <div class="section">
        <div class="section-header">
            <div class="section-icon" style="background: var(--gradient-danger);">üìä</div>
            <h2 class="section-title">Security Metrics Summary</h2>
        </div>

        <div class="metrics-grid">
            <div class="metric-card metric-critical" style="border-left-color: var(--danger-red);">
                <div class="metric-label">Critical Issues</div>
                <div class="metric-value text-danger">{{ critical_count|intcomma }}</div>
                <div class="metric-subtitle">Require immediate action</div>
                <div class="threat-severity-bar" style="margin-top: 10px;">
                    {% for i in "12345" %}
                    <div class="severity-block {% if forloop.counter <= critical_count|slice:":1"|join:""|default:0 %}severity-critical{% else %}severity-empty{% endif %}"></div>
                    {% endfor %}
                </div>
            </div>

            <div class="metric-card metric-security" style="border-left-color: var(--warning-orange);">
                <div class="metric-label">High Priority</div>
                <div class="metric-value text-warning">{{ high_count|intcomma }}</div>
                <div class="metric-subtitle">Address within 1 week</div>
                <div class="threat-severity-bar" style="margin-top: 10px;">
                    {% for i in "12345" %}
                    <div class="severity-block {% if forloop.counter <= high_count|slice:":1"|join:""|default:0 %}severity-high{% else %}severity-empty{% endif %}"></div>
                    {% endfor %}
                </div>
            </div>

            <div class="metric-card" style="border-left-color: var(--warning-yellow);">
                <div class="metric-label">Medium Priority</div>
                <div class="metric-value" style="color: var(--warning-yellow);">{{ medium_count|intcomma }}</div>
                <div class="metric-subtitle">Address within 1 month</div>
                <div class="threat-severity-bar" style="margin-top: 10px;">
                    {% for i in "12345" %}
                    <div class="severity-block {% if forloop.counter <= medium_count|slice:":1"|join:""|default:0 %}severity-medium{% else %}severity-empty{% endif %}"></div>
                    {% endfor %}
                </div>
            </div>

            <div class="metric-card metric-cost" style="border-left-color: var(--success-green);">
                <div class="metric-label">Total Security Findings</div>
                <div class="metric-value">{{ total_security_findings|intcomma }}</div>
                <div class="metric-subtitle">Across all resources</div>
            </div>
        </div>
    </div>

    <!-- Threat Landscape Overview -->
    <div class="section">
        <div class="section-header">
            <div class="section-icon icon-security">üéØ</div>
            <h2 class="section-title">Threat Landscape Overview</h2>
        </div>

        <div class="warning-box">
            <div class="info-box-icon">‚ö†Ô∏è</div>
            <h3>Security Posture Summary</h3>
            <p style="font-size: 1.1em; line-height: 1.8; margin-top: 15px;">
                Azure Advisor has identified <strong>{{ total_security_findings|intcomma }} security findings</strong> across your Azure environment.
                {% if critical_count > 0 %}
                <strong style="color: var(--danger-red);">{{ critical_count|intcomma }} critical vulnerabilities</strong> pose significant risk and require immediate remediation within 24 hours to prevent potential security breaches.
                {% endif %}
                {% if high_count > 0 %}
                An additional <strong>{{ high_count|intcomma }} high-priority issues</strong> should be addressed within one week to maintain a strong security posture.
                {% endif %}
                Addressing these findings will significantly improve your organization's security stance and compliance readiness.
            </p>
        </div>

        <!-- Security Distribution Chart -->
        <div class="charts-grid" style="margin-top: 40px;">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Security Findings by Severity</h3>
                    <p class="chart-subtitle">Risk distribution analysis</p>
                </div>
                <div class="chart-wrapper">
                    <canvas id="severityChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Findings by Resource Type</h3>
                    <p class="chart-subtitle">Most vulnerable components</p>
                </div>
                <div class="chart-wrapper">
                    <canvas id="resourceTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Critical Security Issues -->
    {% if critical_issues %}
    <div class="section">
        <div class="section-header">
            <div class="section-icon" style="background: var(--gradient-danger);">üö®</div>
            <h2 class="section-title">Critical Security Issues - Immediate Action Required</h2>
            <span class="section-count">{{ critical_issues.count }} items</span>
        </div>

        <div class="danger-box">
            <div class="info-box-icon">‚ö†Ô∏è</div>
            <p><strong>HIGH RISK:</strong> These {{ critical_issues.count|intcomma }} critical security issues pose significant risk to your environment and require immediate remediation to prevent potential security breaches, data loss, or compliance violations. Executive escalation recommended.</p>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th>Security Issue</th>
                        <th style="width: 200px;">Affected Resource</th>
                        <th style="width: 120px; text-align: center;">Risk Level</th>
                        <th style="width: 120px; text-align: center;">Timeline</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in critical_issues %}
                    <tr style="background-color: rgba(209, 52, 56, 0.03);">
                        <td class="text-center">
                            <strong class="text-danger text-xl">{{ forloop.counter }}</strong>
                        </td>
                        <td>
                            <strong style="color: var(--danger-red);">{{ rec.recommendation|truncatewords:20 }}</strong>
                            {% if rec.potential_benefits %}
                            <div class="text-sm text-muted" style="margin-top: 5px;">
                                <strong>Impact:</strong> {{ rec.potential_benefits|truncatewords:20 }}
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="font-semibold">{{ rec.resource_name|default:"Unknown Resource"|truncatechars:25 }}</div>
                            <div class="text-xs text-muted">{{ rec.resource_type|default:"Unknown Type"|truncatechars:30 }}</div>
                        </td>
                        <td class="text-center">
                            <span class="risk-indicator risk-critical">CRITICAL</span>
                        </td>
                        <td class="text-center">
                            <strong style="background: var(--danger-red); color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.9em;">
                                24 Hours
                            </strong>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- High Priority Security Issues -->
    {% if high_priority_issues %}
    <div class="section">
        <div class="section-header">
            <div class="section-icon icon-security">‚ö†Ô∏è</div>
            <h2 class="section-title">High Priority Security Issues</h2>
            <span class="section-count">{{ high_priority_issues.count }} items</span>
        </div>

        <div class="warning-box">
            <p>These {{ high_priority_issues.count|intcomma }} security issues should be addressed within one week to maintain a strong security posture and prevent potential exploitation.</p>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Security Issue</th>
                        <th style="width: 200px;">Affected Resource</th>
                        <th style="width: 120px; text-align: center;">Risk Level</th>
                        <th style="width: 120px; text-align: center;">Timeline</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in high_priority_issues %}
                    <tr>
                        <td>
                            <strong>{{ rec.recommendation|truncatewords:20 }}</strong>
                            {% if rec.potential_benefits %}
                            <div class="text-sm text-muted" style="margin-top: 4px;">
                                {{ rec.potential_benefits|truncatewords:15 }}
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="font-semibold text-sm">{{ rec.resource_name|default:"Unknown Resource"|truncatechars:25 }}</div>
                            <div class="text-xs text-muted">{{ rec.resource_type|default:"Unknown Type"|truncatechars:25 }}</div>
                        </td>
                        <td class="text-center">
                            <span class="risk-indicator risk-high">HIGH</span>
                        </td>
                        <td class="text-center">
                            <span style="font-weight: 600; color: var(--warning-orange);">1 Week</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Security by Subscription -->
    {% if security_by_subscription %}
    <div class="section">
        <div class="section-header">
            <div class="section-icon">‚òÅÔ∏è</div>
            <h2 class="section-title">Security Findings by Azure Subscription</h2>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Subscription</th>
                        <th style="text-align: center;">Critical</th>
                        <th style="text-align: center;">High</th>
                        <th style="text-align: center;">Medium</th>
                        <th style="text-align: center;">Total</th>
                        <th style="text-align: center;">Risk Distribution</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sub in security_by_subscription %}
                    <tr>
                        <td>
                            <strong>{{ sub.subscription_name|default:"Unknown Subscription"|truncatechars:40 }}</strong>
                        </td>
                        <td class="text-center">
                            {% if sub.critical_count > 0 %}
                            <span class="badge badge-high">{{ sub.critical_count|intcomma }}</span>
                            {% else %}
                            <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if sub.high_count > 0 %}
                            <span class="badge badge-medium">{{ sub.high_count|intcomma }}</span>
                            {% else %}
                            <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if sub.medium_count > 0 %}
                            <span class="badge badge-low">{{ sub.medium_count|intcomma }}</span>
                            {% else %}
                            <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <strong class="text-lg">{{ sub.total_count|intcomma }}</strong>
                        </td>
                        <td>
                            {% if sub.total_count > 0 %}
                            <div style="display: flex; height: 24px; border-radius: 12px; overflow: hidden;">
                                {% widthratio sub.critical_count sub.total_count 100 as critical_pct %}
                                {% widthratio sub.high_count sub.total_count 100 as high_pct %}
                                {% widthratio sub.medium_count sub.total_count 100 as medium_pct %}
                                <div style="width: {{ critical_pct }}%; background: var(--danger-red);"></div>
                                <div style="width: {{ high_pct }}%; background: var(--warning-orange);"></div>
                                <div style="width: {{ medium_pct }}%; background: var(--warning-yellow);"></div>
                            </div>
                            {% else %}
                            <span class="text-muted" style="font-size: 0.9em;">No findings</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Compliance & Standards -->
    <div class="section">
        <div class="section-header">
            <div class="section-icon" style="background: linear-gradient(135deg, #8661C5 0%, #9966FF 100%);">üìú</div>
            <h2 class="section-title">Compliance & Regulatory Framework Alignment</h2>
        </div>

        <div class="info-box">
            <div class="info-box-icon">üîê</div>
            <h3>Regulatory Framework Impact</h3>
            <p style="margin-top: 15px; line-height: 1.8;">
                Addressing these security recommendations helps maintain compliance with common security frameworks and regulatory requirements. These findings may impact your organization's ability to meet compliance obligations.
            </p>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
            <div class="compliance-badge">
                <div class="compliance-icon">üîí</div>
                <div>
                    <strong>ISO 27001</strong>
                    <div style="font-size: 0.85em; color: var(--gray-600); margin-top: 3px;">
                        Information Security Management
                    </div>
                </div>
            </div>

            <div class="compliance-badge">
                <div class="compliance-icon">üõ°Ô∏è</div>
                <div>
                    <strong>NIST CSF</strong>
                    <div style="font-size: 0.85em; color: var(--gray-600); margin-top: 3px;">
                        Cybersecurity Framework
                    </div>
                </div>
            </div>

            <div class="compliance-badge">
                <div class="compliance-icon">üìã</div>
                <div>
                    <strong>CIS Controls</strong>
                    <div style="font-size: 0.85em; color: var(--gray-600); margin-top: 3px;">
                        Critical Security Controls
                    </div>
                </div>
            </div>

            <div class="compliance-badge">
                <div class="compliance-icon">üîê</div>
                <div>
                    <strong>SOC 2 Type II</strong>
                    <div style="font-size: 0.85em; color: var(--gray-600); margin-top: 3px;">
                        Trust Service Principles
                    </div>
                </div>
            </div>

            <div class="compliance-badge">
                <div class="compliance-icon">üè•</div>
                <div>
                    <strong>HIPAA</strong>
                    <div style="font-size: 0.85em; color: var(--gray-600); margin-top: 3px;">
                        Healthcare Data Protection
                    </div>
                </div>
            </div>

            <div class="compliance-badge">
                <div class="compliance-icon">üí≥</div>
                <div>
                    <strong>PCI DSS</strong>
                    <div style="font-size: 0.85em; color: var(--gray-600); margin-top: 3px;">
                        Payment Card Industry Standards
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Remediation Roadmap -->
    <div class="section">
        <div class="section-header">
            <div class="section-icon" style="background: var(--gradient-azure);">üó∫Ô∏è</div>
            <h2 class="section-title">Security Remediation Roadmap</h2>
        </div>

        <div class="danger-box">
            <div class="info-box-icon">üî¥</div>
            <h3>Phase 1: Critical Response (24 Hours)</h3>
            <ol style="margin-left: 20px; margin-top: 15px; line-height: 2.2;">
                <li><strong>Emergency Triage:</strong> Convene security team to review all {{ critical_count|intcomma }} critical findings within 2 hours</li>
                <li><strong>Immediate Mitigations:</strong> Implement temporary security controls and workarounds for critical vulnerabilities</li>
                <li><strong>Incident Response:</strong> Activate incident response procedures if any active exploitation detected</li>
                <li><strong>Executive Notification:</strong> Brief leadership team on critical security posture and remediation plan</li>
                <li><strong>Vendor Escalation:</strong> Engage Microsoft support for critical Azure security issues if needed</li>
            </ol>
        </div>

        <div class="warning-box" style="margin-top: 20px;">
            <div class="info-box-icon">üü°</div>
            <h3>Phase 2: Short-term Hardening (Week 1)</h3>
            <ol style="margin-left: 20px; margin-top: 15px; line-height: 2.2;">
                <li><strong>High Priority Remediation:</strong> Address all {{ high_count|intcomma }} high-priority security findings</li>
                <li><strong>Security Policy Updates:</strong> Review and update security policies, firewall rules, and access controls</li>
                <li><strong>MFA Enforcement:</strong> Ensure multi-factor authentication is enabled for all privileged accounts</li>
                <li><strong>Security Awareness:</strong> Conduct targeted training for teams responsible for affected resources</li>
                <li><strong>Enhanced Monitoring:</strong> Implement additional security monitoring and alerting</li>
            </ol>
        </div>

        <div class="success-box" style="margin-top: 20px;">
            <div class="info-box-icon">üü¢</div>
            <h3>Phase 3: Continuous Improvement (Month 1 & Ongoing)</h3>
            <ol style="margin-left: 20px; margin-top: 15px; line-height: 2.2;">
                <li><strong>Complete Remediation:</strong> Address all {{ medium_count|intcomma }} medium-priority findings</li>
                <li><strong>Security Automation:</strong> Implement Azure Policy and automated security guardrails</li>
                <li><strong>Regular Assessments:</strong> Establish weekly Azure Advisor security reviews until posture improves</li>
                <li><strong>Penetration Testing:</strong> Conduct third-party security assessment to validate improvements</li>
                <li><strong>Security Metrics:</strong> Create executive dashboard tracking security KPIs and remediation progress</li>
                <li><strong>Zero Trust Implementation:</strong> Begin journey toward Zero Trust architecture</li>
            </ol>
        </div>
    </div>

    <!-- Security Best Practices -->
    <div class="section">
        <div class="section-header">
            <div class="section-icon icon-operations">üí°</div>
            <h2 class="section-title">Security Best Practices & Recommendations</h2>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon">üîÑ</div>
                <div class="metric-label">Continuous Monitoring</div>
                <div style="font-size: 0.95em; line-height: 1.6; margin-top: 10px; color: var(--gray-700);">
                    Enable Azure Security Center and review Azure Advisor security recommendations weekly
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon">üõ°Ô∏è</div>
                <div class="metric-label">Defense in Depth</div>
                <div style="font-size: 0.95em; line-height: 1.6; margin-top: 10px; color: var(--gray-700);">
                    Implement multiple layers: network, identity, application, and data protection
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon">üîê</div>
                <div class="metric-label">Zero Trust Model</div>
                <div style="font-size: 0.95em; line-height: 1.6; margin-top: 10px; color: var(--gray-700);">
                    Verify explicitly, use least privilege, and assume breach in security design
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon">üéì</div>
                <div class="metric-label">Security Culture</div>
                <div style="font-size: 0.95em; line-height: 1.6; margin-top: 10px; color: var(--gray-700);">
                    Regular training, awareness programs, and security champions program
                </div>
            </div>
        </div>
    </div>

    <!-- Next Steps -->
    <div class="section">
        <div class="section-header">
            <div class="section-icon" style="background: var(--gradient-success);">‚úÖ</div>
            <h2 class="section-title">Immediate Action Items</h2>
        </div>

        <div class="success-box">
            <h3>Security Leadership Actions</h3>
            <ol style="line-height: 2.5; font-size: 1.05em; margin: 20px 0 20px 20px;">
                <li><strong>Emergency Review:</strong> CISO/Security team review within 2 hours for critical findings</li>
                <li><strong>Assign Ownership:</strong> Designate security incident response team for immediate remediation</li>
                <li><strong>Stakeholder Communication:</strong> Brief executive team and board on security posture</li>
                <li><strong>Budget Allocation:</strong> Secure emergency budget for critical security improvements</li>
                <li><strong>Third-party Assessment:</strong> Consider engaging external security consultants for validation</li>
                <li><strong>Compliance Review:</strong> Engage legal/compliance teams to assess regulatory implications</li>
                <li><strong>Track Progress:</strong> Implement daily stand-ups until all critical issues resolved</li>
                <li><strong>Post-mortem:</strong> Conduct lessons learned session and update security procedures</li>
            </ol>
        </div>
    </div>

    <!-- Charts JavaScript -->
    <script>
        // Wait for DOM to be ready - Compatible with Playwright PDF generation
        (function() {
            function initializeCharts() {
                // Severity Distribution Chart
                const severityCtx = document.getElementById('severityChart');
            if (severityCtx) {
                new Chart(severityCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Critical', 'High Priority', 'Medium Priority'],
                        datasets: [{
                            data: [{{ critical_count }}, {{ high_count }}, {{ medium_count }}],
                            backgroundColor: ['#D13438', '#FF8C00', '#FFB900'],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 10,
                                bottom: 10,
                                left: 10,
                                right: 10
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 12,
                                    font: { size: 12, weight: '600', family: "'Segoe UI', sans-serif" },
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    boxWidth: 12
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed + ' findings';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Resource Type Chart (if data available)
            {% if security_by_resource_type %}
            const resourceCtx = document.getElementById('resourceTypeChart');
            if (resourceCtx) {
                new Chart(resourceCtx, {
                    type: 'bar',
                    data: {
                        labels: [{% for item in security_by_resource_type|slice:":8" %}'{{ item.resource_type|truncatechars:20 }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                        datasets: [{
                            label: 'Security Findings',
                            data: [{% for item in security_by_resource_type|slice:":8" %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                            backgroundColor: '#FF8C00',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 10,
                                bottom: 10,
                                left: 10,
                                right: 10
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            },
                            y: { grid: { display: false } }
                        }
                    }
                });
            }
            {% endif %}
            }

            // Execute when DOM is ready - works with both normal page load and Playwright set_content()
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeCharts);
            } else {
                // DOM is already ready, execute immediately
                initializeCharts();
            }
        })();
    </script>
{% endblock %}
