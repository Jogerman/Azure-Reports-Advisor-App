{% load report_filters %}

{% comment %}
    Saving Plans & Reserved Instances Section (v2.0.1 - FIXED)

    IMPORTANT: Azure Advisor CSV exports do NOT specify commitment terms (1-year vs 3-year).
    They only provide annual savings for the recommended term.

    This template displays reservation-based recommendations with focus on:
    - Annual savings estimates
    - Breakdown by reservation type only
    - Detailed recommendations

    Context required:
    - reservation_metrics: Dictionary with reservation metrics from get_reservation_metrics()
{% endcomment %}

{% if reservation_metrics.has_reservations %}
<div class="section" style="page-break-inside: avoid; margin-top: 40px;">
    <h2 style="color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-bottom: 30px;">
        üí∞ Saving Plans & Reserved Instances Analysis
    </h2>

    <!-- Important Notice -->
    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 25px; border-radius: 5px;">
        <div style="font-weight: 600; color: #856404; margin-bottom: 8px; font-size: 13px;">‚ö†Ô∏è Important Note About Commitment Terms</div>
        <p style="margin: 0; color: #856404; font-size: 12px; line-height: 1.5;">
            Azure Advisor CSV exports show <strong>annual savings</strong> for the recommended commitment term but do not specify whether that term is 1-year or 3-year.
            When purchasing reservations in Azure Portal, you can choose between 1-year (~40% discount) or 3-year (~60% discount) terms.
            All savings shown below are annual estimates - confirm actual terms and pricing in Azure Portal before purchasing.
        </p>
    </div>

    <!-- Summary Cards -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
        <!-- Total Reservations Card -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total Reservation Opportunities</div>
            <div style="font-size: 32px; font-weight: bold;">{{ reservation_metrics.total_count|intcomma }}</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Savings Plans & Reserved Instances</div>
        </div>

        <!-- Annual Savings Card -->
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total Annual Savings Potential</div>
            <div style="font-size: 32px; font-weight: bold;">${{ reservation_metrics.total_annual_savings|floatformat:2|intcomma }}</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Estimated yearly cost reduction</div>
        </div>
    </div>

    <!-- Breakdown Section -->
    {% if reservation_metrics.by_type %}
    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #3498db; margin-bottom: 30px;">
        <h3 style="margin-top: 0; color: #2c3e50; font-size: 18px;">Breakdown by Reservation Type</h3>
        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
            <thead>
                <tr style="background: #e9ecef;">
                    <th style="padding: 10px; text-align: left; font-size: 12px; color: #6c757d; border-bottom: 2px solid #dee2e6;">Type</th>
                    <th style="padding: 10px; text-align: right; font-size: 12px; color: #6c757d; border-bottom: 2px solid #dee2e6;">Count</th>
                    <th style="padding: 10px; text-align: right; font-size: 12px; color: #6c757d; border-bottom: 2px solid #dee2e6;">Annual Savings</th>
                </tr>
            </thead>
            <tbody>
                {% for type_data in reservation_metrics.by_type %}
                <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 10px; font-size: 13px;">{{ type_data.type_display }}</td>
                    <td style="padding: 10px; text-align: right; font-size: 13px; font-weight: 600;">{{ type_data.count|intcomma }}</td>
                    <td style="padding: 10px; text-align: right; font-size: 13px; font-weight: 600; color: #28a745;">${{ type_data.annual_savings|floatformat:2|intcomma }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Top Reservation Recommendations -->
    {% if reservation_metrics.recommendations %}
    <div style="background: #ffffff; padding: 20px; border-radius: 10px; border: 1px solid #dee2e6; margin-top: 30px;">
        <h3 style="margin-top: 0; color: #2c3e50; font-size: 18px; margin-bottom: 20px;">
            üèÜ Top Reservation Opportunities
        </h3>

        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #343a40; color: white;">
                    <th style="padding: 12px; text-align: left; font-size: 12px;">Recommendation</th>
                    <th style="padding: 12px; text-align: center; font-size: 12px;">Type</th>
                    <th style="padding: 12px; text-align: center; font-size: 12px;">Impact</th>
                    <th style="padding: 12px; text-align: right; font-size: 12px;">Annual Savings</th>
                </tr>
            </thead>
            <tbody>
                {% for rec in reservation_metrics.recommendations|slice:":10" %}
                <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-size: 12px; max-width: 300px;">
                        <div style="font-weight: 600; margin-bottom: 3px;">{{ rec.resource_name|default:"General Recommendation" }}</div>
                        <div style="color: #6c757d; font-size: 11px;">{{ rec.recommendation|truncatewords:20 }}</div>
                        {% if rec.resource_group %}
                        <div style="color: #95a5a6; font-size: 10px; margin-top: 2px;">{{ rec.resource_group }}</div>
                        {% endif %}
                    </td>
                    <td style="padding: 12px; text-align: center; font-size: 11px;">
                        {% if rec.reservation_type == 'reserved_instance' %}
                        <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 4px; font-weight: 600;">Reserved Instance</span>
                        {% elif rec.reservation_type == 'savings_plan' %}
                        <span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 8px; border-radius: 4px; font-weight: 600;">Savings Plan</span>
                        {% elif rec.reservation_type == 'reserved_capacity' %}
                        <span style="background: #e8f5e9; color: #388e3c; padding: 4px 8px; border-radius: 4px; font-weight: 600;">Reserved Capacity</span>
                        {% else %}
                        <span style="background: #fafafa; color: #757575; padding: 4px 8px; border-radius: 4px; font-weight: 600;">Other</span>
                        {% endif %}
                    </td>
                    <td style="padding: 12px; text-align: center; font-size: 11px;">
                        {% if rec.business_impact == 'high' %}
                        <span style="background: #ffebee; color: #c62828; padding: 4px 8px; border-radius: 4px; font-weight: 600;">High</span>
                        {% elif rec.business_impact == 'medium' %}
                        <span style="background: #fff3e0; color: #e65100; padding: 4px 8px; border-radius: 4px; font-weight: 600;">Medium</span>
                        {% else %}
                        <span style="background: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-weight: 600;">Low</span>
                        {% endif %}
                    </td>
                    <td style="padding: 12px; text-align: right; font-size: 14px; font-weight: 700; color: #28a745;">
                        ${{ rec.potential_savings|floatformat:2|intcomma }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Key Insights Box -->
    <div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; margin-top: 30px; border-radius: 5px;">
        <div style="font-weight: 600; color: #2e7d32; margin-bottom: 8px;">üí° Key Insights & Recommendations</div>
        <ul style="margin: 0; padding-left: 20px; color: #2e7d32; font-size: 13px; line-height: 1.6;">
            <li>Total annual savings potential: <strong>${{ reservation_metrics.total_annual_savings|floatformat:2|intcomma }}</strong> per year</li>
            <li>Average annual savings per recommendation: <strong>${{ reservation_metrics.average_annual_savings|floatformat:2|intcomma }}</strong></li>
            <li>{{ reservation_metrics.total_count|intcomma }} reservation opportunities identified across {{ reservation_metrics.by_type|length|intcomma }} different types</li>
            <li><strong>Important:</strong> Commitment terms (1-year or 3-year) and final pricing must be confirmed in Azure Portal when purchasing</li>
            <li><strong>Recommendation:</strong> Longer commitment terms (3-year) typically offer higher discounts (~60%) compared to 1-year (~40%), but require longer commitments</li>
        </ul>
    </div>
</div>
{% endif %}
