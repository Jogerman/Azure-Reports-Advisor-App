{% load report_filters %}

{% comment %}
    Saving Plans & Reserved Instances Section (v1.6.3)

    This template displays reservation-based recommendations with focus on:
    - Total commitment savings over the full term
    - Breakdown by reservation type and commitment term
    - Detailed recommendations with ROI analysis

    Context required:
    - reservation_metrics: Dictionary with reservation metrics from get_reservation_metrics()
{% endcomment %}

{% if reservation_metrics.has_reservations %}
<div class="section" style="page-break-inside: avoid; margin-top: 40px;">
    <h2 style="color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-bottom: 30px;">
        üí∞ Saving Plans & Reserved Instances Analysis
    </h2>

    <!-- Summary Cards -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
        <!-- Total Reservations Card -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total Reservations</div>
            <div style="font-size: 32px; font-weight: bold;">{{ reservation_metrics.total_count|intcomma }}</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Recommendations</div>
        </div>

        <!-- Annual Savings Card -->
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Annual Savings</div>
            <div style="font-size: 32px; font-weight: bold;">${{ reservation_metrics.total_annual_savings|floatformat:2|intcomma }}</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Per Year</div>
        </div>

        <!-- Total Commitment Savings Card -->
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total Commitment Savings</div>
            <div style="font-size: 32px; font-weight: bold;">${{ reservation_metrics.total_commitment_savings|floatformat:2|intcomma }}</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Over Full Term</div>
        </div>
    </div>

    <!-- Breakdown Section -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
        <!-- By Reservation Type -->
        {% if reservation_metrics.by_type %}
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #3498db;">
            <h3 style="margin-top: 0; color: #2c3e50; font-size: 18px;">Breakdown by Reservation Type</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr style="background: #e9ecef;">
                        <th style="padding: 10px; text-align: left; font-size: 12px; color: #6c757d; border-bottom: 2px solid #dee2e6;">Type</th>
                        <th style="padding: 10px; text-align: right; font-size: 12px; color: #6c757d; border-bottom: 2px solid #dee2e6;">Count</th>
                        <th style="padding: 10px; text-align: right; font-size: 12px; color: #6c757d; border-bottom: 2px solid #dee2e6;">Commitment Savings</th>
                    </tr>
                </thead>
                <tbody>
                    {% for type_data in reservation_metrics.by_type %}
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 10px; font-size: 13px;">{{ type_data.type_display }}</td>
                        <td style="padding: 10px; text-align: right; font-size: 13px; font-weight: 600;">{{ type_data.count|intcomma }}</td>
                        <td style="padding: 10px; text-align: right; font-size: 13px; font-weight: 600; color: #28a745;">${{ type_data.commitment_savings|floatformat:2|intcomma }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- By Commitment Term -->
        {% if reservation_metrics.by_term %}
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #9b59b6;">
            <h3 style="margin-top: 0; color: #2c3e50; font-size: 18px;">Breakdown by Commitment Term</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr style="background: #e9ecef;">
                        <th style="padding: 10px; text-align: left; font-size: 12px; color: #6c757d; border-bottom: 2px solid #dee2e6;">Term</th>
                        <th style="padding: 10px; text-align: right; font-size: 12px; color: #6c757d; border-bottom: 2px solid #dee2e6;">Count</th>
                        <th style="padding: 10px; text-align: right; font-size: 12px; color: #6c757d; border-bottom: 2px solid #dee2e6;">Commitment Savings</th>
                    </tr>
                </thead>
                <tbody>
                    {% for term_data in reservation_metrics.by_term %}
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 10px; font-size: 13px;">{{ term_data.term_display }}</td>
                        <td style="padding: 10px; text-align: right; font-size: 13px; font-weight: 600;">{{ term_data.count|intcomma }}</td>
                        <td style="padding: 10px; text-align: right; font-size: 13px; font-weight: 600; color: #28a745;">${{ term_data.commitment_savings|floatformat:2|intcomma }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- Top Reservation Recommendations -->
    {% if reservation_metrics.recommendations %}
    <div style="background: #ffffff; padding: 20px; border-radius: 10px; border: 1px solid #dee2e6; margin-top: 30px;">
        <h3 style="margin-top: 0; color: #2c3e50; font-size: 18px; margin-bottom: 20px;">
            üèÜ Top Reservation Opportunities
        </h3>

        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #343a40; color: white;">
                    <th style="padding: 12px; text-align: left; font-size: 12px;">Recommendation</th>
                    <th style="padding: 12px; text-align: center; font-size: 12px;">Type</th>
                    <th style="padding: 12px; text-align: center; font-size: 12px;">Term</th>
                    <th style="padding: 12px; text-align: right; font-size: 12px;">Annual Savings</th>
                    <th style="padding: 12px; text-align: right; font-size: 12px;">Total Commitment</th>
                </tr>
            </thead>
            <tbody>
                {% for rec in reservation_metrics.recommendations|slice:":10" %}
                <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-size: 12px; max-width: 300px;">
                        <div style="font-weight: 600; margin-bottom: 3px;">{{ rec.resource_name|default:"General Recommendation" }}</div>
                        <div style="color: #6c757d; font-size: 11px;">{{ rec.recommendation|truncatewords:20 }}</div>
                    </td>
                    <td style="padding: 12px; text-align: center; font-size: 11px;">
                        {% if rec.reservation_type == 'reserved_instance' %}
                        <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 4px; font-weight: 600;">Reserved Instance</span>
                        {% elif rec.reservation_type == 'savings_plan' %}
                        <span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 8px; border-radius: 4px; font-weight: 600;">Savings Plan</span>
                        {% elif rec.reservation_type == 'reserved_capacity' %}
                        <span style="background: #e8f5e9; color: #388e3c; padding: 4px 8px; border-radius: 4px; font-weight: 600;">Reserved Capacity</span>
                        {% else %}
                        <span style="background: #fafafa; color: #757575; padding: 4px 8px; border-radius: 4px; font-weight: 600;">Other</span>
                        {% endif %}
                    </td>
                    <td style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600;">
                        {% if rec.commitment_term_years %}
                        {{ rec.commitment_term_years|intcomma }} Year{{ rec.commitment_term_years|pluralize }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600; color: #28a745;">
                        ${{ rec.potential_savings|floatformat:2|intcomma }}
                    </td>
                    <td style="padding: 12px; text-align: right; font-size: 13px; font-weight: 700; color: #007bff;">
                        {% if rec.commitment_term_years and rec.potential_savings %}
                        ${{ rec.potential_savings|multiply:rec.commitment_term_years|floatformat:2|intcomma }}
                        {% else %}
                        ${{ rec.potential_savings|floatformat:2|intcomma }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Key Insights Box -->
    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-top: 30px; border-radius: 5px;">
        <div style="font-weight: 600; color: #856404; margin-bottom: 8px;">üí° Key Insights</div>
        <ul style="margin: 0; padding-left: 20px; color: #856404; font-size: 13px; line-height: 1.6;">
            <li>Total potential commitment savings of <strong>${{ reservation_metrics.total_commitment_savings|floatformat:2|intcomma }}</strong> over the full reservation terms</li>
            <li>Average annual savings per reservation: <strong>${{ reservation_metrics.average_annual_savings|floatformat:2|intcomma }}</strong></li>
            <li>{{ reservation_metrics.total_count|intcomma }} reservation opportunities identified across {{ reservation_metrics.by_type|length|intcomma }} different types</li>
            {% if reservation_metrics.by_term %}
            <li>Commitment terms range from {{ reservation_metrics.by_term.0.term_years|intcomma }} to {{ reservation_metrics.by_term|last:term_years|intcomma }} years</li>
            {% endif %}
        </ul>
    </div>
</div>
{% endif %}
