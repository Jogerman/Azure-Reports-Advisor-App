{% load report_filters %}

{% comment %}
    Enhanced Saving Plans & Reservations Analysis (v2.0.1 - FIXED)

    IMPORTANT: Azure Advisor CSV exports do NOT specify commitment terms (1-year vs 3-year).
    They only provide annual savings for the recommended term (typically 3-year for max savings).

    This template shows:
    1. Pure Reservations (unified view - annual savings only)
    2. Pure Savings Plans (annual savings only)
    3. Combined Commitments (annual savings only)

    Context required:
    - pure_reservation_metrics
    - savings_plan_metrics
    - combined_commitment_metrics
{% endcomment %}

<div class="section" style="page-break-inside: avoid; margin-top: 50px;">
    <h1 style="color: #201F1E; border-bottom: 4px solid #0078D4; padding-bottom: 15px; margin-bottom: 40px;">
        Azure Commitment Savings Analysis
    </h1>

    <!-- SECTION 1: PURE RESERVATIONS ONLY -->
    {% if pure_reservation_metrics.has_pure_reservations %}
    <div style="margin-bottom: 60px;">
        <h2 style="color: #107C10; border-left: 6px solid #107C10; padding-left: 15px; margin-bottom: 30px;">
            Traditional Reservations (VM Instances & Capacity)
        </h2>

        <!-- Important Notice -->
        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 30px; border-radius: 5px;">
            <div style="font-weight: 600; color: #856404; margin-bottom: 8px; font-size: 13px;">⚠️ Important Note About Commitment Terms</div>
            <p style="margin: 0; color: #856404; font-size: 12px; line-height: 1.5;">
                Azure Advisor CSV exports show <strong>annual savings</strong> for the recommended commitment term but do not specify whether that term is 1-year or 3-year.
                When purchasing reservations in Azure Portal, you can choose between 1-year (~40% discount) or 3-year (~60% discount) terms.
                The savings shown below are annual estimates - confirm actual terms and pricing in Azure Portal before purchasing.
            </p>
        </div>

        <!-- Summary Cards for All Reservations -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 40px;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Reservation Opportunities</div>
                <div style="font-size: 36px; font-weight: bold;">{{ pure_reservation_metrics.total_count|intcomma }}</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Reserved Instances & Capacity</div>
            </div>

            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Annual Savings Potential</div>
                <div style="font-size: 36px; font-weight: bold;">${{ pure_reservation_metrics.total_annual_savings|floatformat:0|intcomma }}</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Estimated yearly cost reduction</div>
            </div>
        </div>

        <!-- UNIFIED RESERVATIONS TABLE -->
        <div style="background: #ffffff; padding: 30px; border-radius: 12px; border: 2px solid #0078D4; margin-bottom: 40px;">
            <h3 style="margin-top: 0; color: #201F1E; font-size: 20px; margin-bottom: 20px;">
                All Traditional Reservation Opportunities
            </h3>

            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #0078D4; color: white;">
                        <th style="padding: 12px; text-align: left; font-size: 13px;">Resource</th>
                        <th style="padding: 12px; text-align: center; font-size: 13px;">Type</th>
                        <th style="padding: 12px; text-align: center; font-size: 13px;">Impact</th>
                        <th style="padding: 12px; text-align: right; font-size: 13px;">Annual Savings</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in pure_reservation_metrics.all_recommendations %}
                    {% if rec.potential_savings > 0 %}
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 15px;">
                            <div style="font-weight: 600; margin-bottom: 5px;">{{ rec.resource_name|default:"General Recommendation"|truncatechars:40 }}</div>
                            <div style="color: #6c757d; font-size: 11px;">{{ rec.recommendation|truncatewords:15 }}</div>
                            <div style="color: #95a5a6; font-size: 10px; margin-top: 3px;">
                                {% if rec.resource_group %}{{ rec.resource_group }}{% endif %}
                            </div>
                        </td>
                        <td style="padding: 15px; text-align: center;">
                            <span style="background: #e3f2fd; color: #1976d2; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: 600;">
                                {% if rec.reservation_type == 'reserved_instance' %}VM Instance
                                {% elif rec.reservation_type == 'reserved_capacity' %}Capacity
                                {% else %}{{ rec.reservation_type }}{% endif %}
                            </span>
                        </td>
                        <td style="padding: 15px; text-align: center;">
                            {% if rec.business_impact == 'high' %}
                            <span style="background: #ffebee; color: #c62828; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: 600;">High</span>
                            {% elif rec.business_impact == 'medium' %}
                            <span style="background: #fff3e0; color: #e65100; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: 600;">Medium</span>
                            {% else %}
                            <span style="background: #e8f5e9; color: #2e7d32; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: 600;">Low</span>
                            {% endif %}
                        </td>
                        <td style="padding: 15px; text-align: right; font-size: 16px; font-weight: 700; color: #107C10;">
                            ${{ rec.potential_savings|floatformat:2|intcomma }}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- SECTION 2: PURE SAVINGS PLANS -->
    {% if savings_plan_metrics.has_savings_plans %}
    <div style="margin-bottom: 60px;">
        <h2 style="color: #FF8C00; border-left: 6px solid #FF8C00; padding-left: 15px; margin-bottom: 30px;">
            Azure Compute Savings Plans (Flexible Commitments)
        </h2>

        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; margin-bottom: 30px; border-radius: 5px;">
            <div style="font-weight: 600; color: #856404; margin-bottom: 10px;">About Savings Plans</div>
            <p style="margin: 0; color: #856404; font-size: 14px; line-height: 1.6;">
                Savings Plans offer flexibility across VM families, sizes, and regions with hourly commitment.
                Unlike traditional reservations, you can change VM types without losing savings.
                Available in 1-year or 3-year terms - confirm specific terms when purchasing in Azure Portal.
            </p>
        </div>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
            <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Savings Plan Opportunities</div>
                <div style="font-size: 36px; font-weight: bold;">{{ savings_plan_metrics.count|intcomma }}</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Flexible commitment recommendations</div>
            </div>

            <div style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Annual Savings Potential</div>
                <div style="font-size: 36px; font-weight: bold;">${{ savings_plan_metrics.total_annual_savings|floatformat:0|intcomma }}</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Estimated yearly cost reduction</div>
            </div>
        </div>

        <!-- Savings Plans Table -->
        <div style="background: #ffffff; padding: 30px; border-radius: 12px; border: 2px solid #FF8C00;">
            <h3 style="margin-top: 0; color: #201F1E; font-size: 20px; margin-bottom: 20px;">
                All Savings Plan Opportunities
            </h3>

            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #0078D4; color: white;">
                        <th style="padding: 12px; text-align: left; font-size: 13px;">Recommendation</th>
                        <th style="padding: 12px; text-align: center; font-size: 13px;">Impact</th>
                        <th style="padding: 12px; text-align: right; font-size: 13px;">Annual Savings</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in savings_plan_metrics.all_recommendations %}
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 15px;">
                            <div style="font-weight: 600; margin-bottom: 5px;">{{ rec.resource_name|default:"Compute Savings Plan"|truncatechars:40 }}</div>
                            <div style="color: #6c757d; font-size: 11px;">{{ rec.recommendation|truncatewords:15 }}</div>
                            <div style="color: #95a5a6; font-size: 10px; margin-top: 3px;">
                                {% if rec.resource_group %}{{ rec.resource_group }}{% endif %}
                            </div>
                        </td>
                        <td style="padding: 15px; text-align: center;">
                            {% if rec.business_impact == 'high' %}
                            <span style="background: #ffebee; color: #c62828; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: 600;">High</span>
                            {% elif rec.business_impact == 'medium' %}
                            <span style="background: #fff3e0; color: #e65100; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: 600;">Medium</span>
                            {% else %}
                            <span style="background: #e8f5e9; color: #2e7d32; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: 600;">Low</span>
                            {% endif %}
                        </td>
                        <td style="padding: 15px; text-align: right; font-size: 16px; font-weight: 700; color: #FF8C00;">
                            ${{ rec.potential_savings|floatformat:2|intcomma }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- SECTION 3: COMBINED COMMITMENTS -->
    {% if combined_commitment_metrics.has_combined_commitments %}
    <div style="margin-bottom: 60px;">
        <h2 style="color: #00BCF2; border-left: 6px solid #00BCF2; padding-left: 15px; margin-bottom: 30px;">
            Combined Savings (Savings Plans + Reservations Together)
        </h2>

        <div style="background: #d1ecf1; border-left: 4px solid #0c5460; padding: 20px; margin-bottom: 30px; border-radius: 5px;">
            <div style="font-weight: 600; color: #0c5460; margin-bottom: 10px;">Hybrid Approach</div>
            <p style="margin: 0; color: #0c5460; font-size: 14px; line-height: 1.6;">
                These recommendations combine the flexibility of Savings Plans with the deep discounts of traditional reservations
                for maximum savings. This hybrid approach offers the best of both commitment types.
                Commitment terms (1-year or 3-year) should be confirmed when purchasing in Azure Portal.
            </p>
        </div>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Combined Opportunities</div>
                <div style="font-size: 36px; font-weight: bold;">{{ combined_commitment_metrics.total_count|intcomma }}</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Savings Plans + Reservations</div>
            </div>

            <div style="background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Annual Savings Potential</div>
                <div style="font-size: 36px; font-weight: bold;">${{ combined_commitment_metrics.total_annual_savings|floatformat:0|intcomma }}</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Estimated yearly cost reduction</div>
            </div>
        </div>

        <!-- Combined Commitments Table -->
        <div style="background: #ffffff; padding: 30px; border-radius: 12px; border: 2px solid #00BCF2;">
            <h3 style="margin-top: 0; color: #201F1E; font-size: 20px; margin-bottom: 20px;">
                All Combined Commitment Opportunities
            </h3>

            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #0078D4; color: white;">
                        <th style="padding: 12px; text-align: left; font-size: 13px;">Recommendation</th>
                        <th style="padding: 12px; text-align: center; font-size: 13px;">Impact</th>
                        <th style="padding: 12px; text-align: right; font-size: 13px;">Annual Savings</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in combined_commitment_metrics.all_recommendations %}
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 15px;">
                            <div style="font-weight: 600; margin-bottom: 5px;">{{ rec.resource_name|default:"Combined Commitment"|truncatechars:40 }}</div>
                            <div style="color: #6c757d; font-size: 11px;">{{ rec.recommendation|truncatewords:15 }}</div>
                            <div style="color: #95a5a6; font-size: 10px; margin-top: 3px;">
                                {% if rec.resource_group %}{{ rec.resource_group }}{% endif %}
                            </div>
                        </td>
                        <td style="padding: 15px; text-align: center;">
                            {% if rec.business_impact == 'high' %}
                            <span style="background: #ffebee; color: #c62828; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: 600;">High</span>
                            {% elif rec.business_impact == 'medium' %}
                            <span style="background: #fff3e0; color: #e65100; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: 600;">Medium</span>
                            {% else %}
                            <span style="background: #e8f5e9; color: #2e7d32; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: 600;">Low</span>
                            {% endif %}
                        </td>
                        <td style="padding: 15px; text-align: right; font-size: 16px; font-weight: 700; color: #00BCF2;">
                            ${{ rec.potential_savings|floatformat:2|intcomma }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Strategic Recommendations Box -->
    <div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 20px; margin-top: 40px; border-radius: 5px;">
        <div style="font-weight: 600; color: #2e7d32; margin-bottom: 12px; font-size: 16px;">Strategic Recommendations</div>
        <ul style="margin: 0; padding-left: 20px; color: #2e7d32; font-size: 14px; line-height: 1.8;">
            {% if pure_reservation_metrics.has_pure_reservations %}
            <li><strong>Traditional Reservations:</strong> Available in 1-year or 3-year terms. Longer terms offer higher discounts but require longer commitments. Best for stable, predictable workloads with known resource requirements.</li>
            {% endif %}
            {% if savings_plan_metrics.has_savings_plans %}
            <li><strong>Savings Plans:</strong> Maximum flexibility across VM families, sizes, and regions with hourly commitment. Perfect for dynamic workloads with variable resource needs. Available in 1-year or 3-year terms.</li>
            {% endif %}
            {% if combined_commitment_metrics.has_combined_commitments %}
            <li><strong>Combined Approach:</strong> Layer Savings Plans with Reservations for optimal savings. Use Savings Plans for base capacity and Reservations for specific high-usage resources.</li>
            {% endif %}
            <li><strong>Important:</strong> All savings shown are annual estimates. Actual commitment terms (1-year vs 3-year) and final pricing must be confirmed in Azure Portal when purchasing. Azure typically recommends 3-year terms for maximum savings.</li>
            <li><strong>Action Plan:</strong> Start with Savings Plans for immediate flexibility, then add Reservations for high-utilization resources. Review Azure Portal for current discount rates before committing.</li>
        </ul>
    </div>
</div>
