{% load report_filters %}

{% comment %}
    Enhanced Saving Plans & Reservations Analysis (v2.0)

    Multi-dimensional view with:
    1. Pure Reservations (1-year and 3-year separated)
    2. Pure Savings Plans
    3. Combined Commitments (SP + Reservations)

    Context required:
    - pure_reservation_metrics
    - savings_plan_metrics
    - combined_commitment_metrics
{% endcomment %}

<div class="section" style="page-break-inside: avoid; margin-top: 50px;">
    <h1 style="color: #2c3e50; border-bottom: 4px solid #3498db; padding-bottom: 15px; margin-bottom: 40px;">
        Azure Commitment Savings Analysis
    </h1>

    <!-- SECTION 1: PURE RESERVATIONS ONLY -->
    {% if pure_reservation_metrics.has_pure_reservations %}
    <div style="margin-bottom: 60px;">
        <h2 style="color: #27ae60; border-left: 6px solid #27ae60; padding-left: 15px; margin-bottom: 30px;">
            Traditional Reservations (VM Instances & Capacity)
        </h2>

        <!-- Summary Cards for All Reservations -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Reservations</div>
                <div style="font-size: 36px; font-weight: bold;">{{ pure_reservation_metrics.total_count|intcomma }}</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Traditional RI & RC Opportunities</div>
            </div>

            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">1-Year Reservations</div>
                <div style="font-size: 36px; font-weight: bold;">{{ pure_reservation_metrics.one_year.count|intcomma }}</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">${{ pure_reservation_metrics.one_year.total_commitment_savings|floatformat:0|intcomma }} commitment</div>
            </div>

            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">3-Year Reservations</div>
                <div style="font-size: 36px; font-weight: bold;">{{ pure_reservation_metrics.three_year.count|intcomma }}</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">${{ pure_reservation_metrics.three_year.total_commitment_savings|floatformat:0|intcomma }} commitment</div>
            </div>
        </div>

        <!-- 3-YEAR RESERVATIONS TABLE -->
        {% if pure_reservation_metrics.three_year.count > 0 %}
        <div style="background: #ffffff; padding: 30px; border-radius: 12px; border: 2px solid #3498db; margin-bottom: 40px;">
            <h3 style="margin-top: 0; color: #2c3e50; font-size: 20px; margin-bottom: 20px;">
                3-Year Reservations (Highest Long-Term Value)
            </h3>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <div>
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Count</div>
                    <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">{{ pure_reservation_metrics.three_year.count|intcomma }}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Annual Savings</div>
                    <div style="font-size: 24px; font-weight: bold; color: #27ae60;">${{ pure_reservation_metrics.three_year.total_annual_savings|floatformat:0|intcomma }}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Total 3-Year Commitment</div>
                    <div style="font-size: 24px; font-weight: bold; color: #3498db;">${{ pure_reservation_metrics.three_year.total_commitment_savings|floatformat:0|intcomma }}</div>
                </div>
            </div>

            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #2c3e50; color: white;">
                        <th style="padding: 12px; text-align: left; font-size: 13px;">Resource</th>
                        <th style="padding: 12px; text-align: center; font-size: 13px;">Type</th>
                        <th style="padding: 12px; text-align: right; font-size: 13px;">Annual Savings</th>
                        <th style="padding: 12px; text-align: right; font-size: 13px;">3-Year Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in pure_reservation_metrics.three_year.top_recommendations %}
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 15px;">
                            <div style="font-weight: 600; margin-bottom: 5px;">{{ rec.resource_name|default:"General Recommendation"|truncatechars:40 }}</div>
                            <div style="color: #6c757d; font-size: 11px;">{{ rec.recommendation|truncatewords:15 }}</div>
                        </td>
                        <td style="padding: 15px; text-align: center;">
                            <span style="background: #e3f2fd; color: #1976d2; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: 600;">
                                {% if rec.reservation_type == 'reserved_instance' %}VM Instance
                                {% elif rec.reservation_type == 'reserved_capacity' %}Capacity
                                {% else %}{{ rec.reservation_type }}{% endif %}
                            </span>
                        </td>
                        <td style="padding: 15px; text-align: right; font-size: 14px; font-weight: 600; color: #27ae60;">
                            ${{ rec.potential_savings|floatformat:2|intcomma }}
                        </td>
                        <td style="padding: 15px; text-align: right; font-size: 14px; font-weight: 700; color: #3498db;">
                            ${{ rec.total_commitment_savings|floatformat:2|intcomma }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- 1-YEAR RESERVATIONS TABLE -->
        {% if pure_reservation_metrics.one_year.count > 0 %}
        <div style="background: #ffffff; padding: 30px; border-radius: 12px; border: 2px solid #9b59b6; margin-bottom: 40px;">
            <h3 style="margin-top: 0; color: #2c3e50; font-size: 20px; margin-bottom: 20px;">
                1-Year Reservations (Flexible Short-Term Commitment)
            </h3>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <div>
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Count</div>
                    <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">{{ pure_reservation_metrics.one_year.count|intcomma }}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Annual Savings</div>
                    <div style="font-size: 24px; font-weight: bold; color: #27ae60;">${{ pure_reservation_metrics.one_year.total_annual_savings|floatformat:0|intcomma }}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Total 1-Year Commitment</div>
                    <div style="font-size: 24px; font-weight: bold; color: #9b59b6;">${{ pure_reservation_metrics.one_year.total_commitment_savings|floatformat:0|intcomma }}</div>
                </div>
            </div>

            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #2c3e50; color: white;">
                        <th style="padding: 12px; text-align: left; font-size: 13px;">Resource</th>
                        <th style="padding: 12px; text-align: center; font-size: 13px;">Type</th>
                        <th style="padding: 12px; text-align: right; font-size: 13px;">Annual Savings</th>
                        <th style="padding: 12px; text-align: right; font-size: 13px;">1-Year Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in pure_reservation_metrics.one_year.top_recommendations %}
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 15px;">
                            <div style="font-weight: 600; margin-bottom: 5px;">{{ rec.resource_name|default:"General Recommendation"|truncatechars:40 }}</div>
                            <div style="color: #6c757d; font-size: 11px;">{{ rec.recommendation|truncatewords:15 }}</div>
                        </td>
                        <td style="padding: 15px; text-align: center;">
                            <span style="background: #f3e5f5; color: #7b1fa2; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: 600;">
                                {% if rec.reservation_type == 'reserved_instance' %}VM Instance
                                {% elif rec.reservation_type == 'reserved_capacity' %}Capacity
                                {% else %}{{ rec.reservation_type }}{% endif %}
                            </span>
                        </td>
                        <td style="padding: 15px; text-align: right; font-size: 14px; font-weight: 600; color: #27ae60;">
                            ${{ rec.potential_savings|floatformat:2|intcomma }}
                        </td>
                        <td style="padding: 15px; text-align: right; font-size: 14px; font-weight: 700; color: #9b59b6;">
                            ${{ rec.total_commitment_savings|floatformat:2|intcomma }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- SECTION 2: PURE SAVINGS PLANS -->
    {% if savings_plan_metrics.has_savings_plans %}
    <div style="margin-bottom: 60px;">
        <h2 style="color: #e67e22; border-left: 6px solid #e67e22; padding-left: 15px; margin-bottom: 30px;">
            Azure Compute Savings Plans (Flexible Commitments)
        </h2>

        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; margin-bottom: 30px; border-radius: 5px;">
            <div style="font-weight: 600; color: #856404; margin-bottom: 10px;">About Savings Plans</div>
            <p style="margin: 0; color: #856404; font-size: 14px; line-height: 1.6;">
                Savings Plans offer flexibility across VM families, sizes, and regions with hourly commitment.
                Unlike traditional reservations, you can change VM types without losing savings.
            </p>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
            <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Savings Plan Count</div>
                <div style="font-size: 36px; font-weight: bold;">{{ savings_plan_metrics.count|intcomma }}</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Flexible commitment opportunities</div>
            </div>

            <div style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Annual Savings</div>
                <div style="font-size: 36px; font-weight: bold;">${{ savings_plan_metrics.total_annual_savings|floatformat:0|intcomma }}</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Per year savings potential</div>
            </div>

            <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2c3e50; padding: 25px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 14px; opacity: 0.8; margin-bottom: 8px;">Total Commitment</div>
                <div style="font-size: 36px; font-weight: bold;">${{ savings_plan_metrics.total_commitment_savings|floatformat:0|intcomma }}</div>
                <div style="font-size: 12px; opacity: 0.7; margin-top: 8px;">Over full commitment term</div>
            </div>
        </div>

        <!-- Savings Plans Table -->
        <div style="background: #ffffff; padding: 30px; border-radius: 12px; border: 2px solid #e67e22;">
            <h3 style="margin-top: 0; color: #2c3e50; font-size: 20px; margin-bottom: 20px;">
                Top Savings Plan Opportunities
            </h3>

            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #2c3e50; color: white;">
                        <th style="padding: 12px; text-align: left; font-size: 13px;">Recommendation</th>
                        <th style="padding: 12px; text-align: center; font-size: 13px;">Term</th>
                        <th style="padding: 12px; text-align: right; font-size: 13px;">Annual Savings</th>
                        <th style="padding: 12px; text-align: right; font-size: 13px;">Total Commitment</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in savings_plan_metrics.top_recommendations %}
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 15px;">
                            <div style="font-weight: 600; margin-bottom: 5px;">{{ rec.resource_name|default:"Compute Savings Plan"|truncatechars:40 }}</div>
                            <div style="color: #6c757d; font-size: 11px;">{{ rec.recommendation|truncatewords:15 }}</div>
                        </td>
                        <td style="padding: 15px; text-align: center;">
                            <span style="background: #fff3cd; color: #856404; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: 600;">
                                {{ rec.commitment_term_years|default:"Flexible" }} Year{{ rec.commitment_term_years|pluralize }}
                            </span>
                        </td>
                        <td style="padding: 15px; text-align: right; font-size: 14px; font-weight: 600; color: #27ae60;">
                            ${{ rec.potential_savings|floatformat:2|intcomma }}
                        </td>
                        <td style="padding: 15px; text-align: right; font-size: 14px; font-weight: 700; color: #e67e22;">
                            ${{ rec.total_commitment_savings|floatformat:2|intcomma }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- SECTION 3: COMBINED COMMITMENTS -->
    {% if combined_commitment_metrics.has_combined_commitments %}
    <div style="margin-bottom: 60px;">
        <h2 style="color: #16a085; border-left: 6px solid #16a085; padding-left: 15px; margin-bottom: 30px;">
            Combined Savings (Savings Plans + Reservations Together)
        </h2>

        <div style="background: #d1ecf1; border-left: 4px solid #0c5460; padding: 20px; margin-bottom: 30px; border-radius: 5px;">
            <div style="font-weight: 600; color: #0c5460; margin-bottom: 10px;">Hybrid Approach</div>
            <p style="margin: 0; color: #0c5460; font-size: 14px; line-height: 1.6;">
                These recommendations combine the flexibility of Savings Plans with the deep discounts of traditional reservations
                for maximum savings. This hybrid approach offers the best of both commitment types.
            </p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <!-- SP + 3Y Reservations -->
            {% if combined_commitment_metrics.sp_plus_3y.count > 0 %}
            <div style="background: #ffffff; padding: 25px; border-radius: 12px; border: 2px solid #16a085;">
                <h3 style="margin-top: 0; color: #16a085; font-size: 18px; margin-bottom: 20px;">
                    Savings Plans + 3-Year Reservations
                </h3>

                <div style="margin-bottom: 20px;">
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Opportunities</div>
                    <div style="font-size: 28px; font-weight: bold; color: #2c3e50;">{{ combined_commitment_metrics.sp_plus_3y.count|intcomma }}</div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Total 3-Year Commitment Savings</div>
                    <div style="font-size: 24px; font-weight: bold; color: #16a085;">${{ combined_commitment_metrics.sp_plus_3y.total_commitment_savings|floatformat:0|intcomma }}</div>
                </div>

                {% if combined_commitment_metrics.sp_plus_3y.top_recommendations %}
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 12px; font-weight: 600; color: #6c757d; margin-bottom: 10px;">TOP OPPORTUNITY</div>
                    {% with rec=combined_commitment_metrics.sp_plus_3y.top_recommendations.0 %}
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 5px;">{{ rec.resource_name|default:"Combined Commitment"|truncatechars:30 }}</div>
                    <div style="font-size: 20px; font-weight: bold; color: #16a085;">${{ rec.total_commitment_savings|floatformat:0|intcomma }}</div>
                    {% endwith %}
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- SP + 1Y Reservations -->
            {% if combined_commitment_metrics.sp_plus_1y.count > 0 %}
            <div style="background: #ffffff; padding: 25px; border-radius: 12px; border: 2px solid #3498db;">
                <h3 style="margin-top: 0; color: #3498db; font-size: 18px; margin-bottom: 20px;">
                    Savings Plans + 1-Year Reservations
                </h3>

                <div style="margin-bottom: 20px;">
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Opportunities</div>
                    <div style="font-size: 28px; font-weight: bold; color: #2c3e50;">{{ combined_commitment_metrics.sp_plus_1y.count|intcomma }}</div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Total 1-Year Commitment Savings</div>
                    <div style="font-size: 24px; font-weight: bold; color: #3498db;">${{ combined_commitment_metrics.sp_plus_1y.total_commitment_savings|floatformat:0|intcomma }}</div>
                </div>

                {% if combined_commitment_metrics.sp_plus_1y.top_recommendations %}
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 12px; font-weight: 600; color: #6c757d; margin-bottom: 10px;">TOP OPPORTUNITY</div>
                    {% with rec=combined_commitment_metrics.sp_plus_1y.top_recommendations.0 %}
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 5px;">{{ rec.resource_name|default:"Combined Commitment"|truncatechars:30 }}</div>
                    <div style="font-size: 20px; font-weight: bold; color: #3498db;">${{ rec.total_commitment_savings|floatformat:0|intcomma }}</div>
                    {% endwith %}
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Strategic Recommendations Box -->
    <div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 20px; margin-top: 40px; border-radius: 5px;">
        <div style="font-weight: 600; color: #2e7d32; margin-bottom: 12px; font-size: 16px;">Strategic Recommendations</div>
        <ul style="margin: 0; padding-left: 20px; color: #2e7d32; font-size: 14px; line-height: 1.8;">
            {% if pure_reservation_metrics.has_pure_reservations %}
            <li><strong>3-Year Reservations:</strong> Offer the highest discounts (up to 72%) but require long-term commitment. Best for stable, predictable workloads.</li>
            <li><strong>1-Year Reservations:</strong> Provide flexibility with good savings (up to 40%). Ideal for workloads with medium-term predictability.</li>
            {% endif %}
            {% if savings_plan_metrics.has_savings_plans %}
            <li><strong>Savings Plans:</strong> Maximum flexibility across VM families and regions. Perfect for dynamic workloads with variable resource needs.</li>
            {% endif %}
            {% if combined_commitment_metrics.has_combined_commitments %}
            <li><strong>Combined Approach:</strong> Layer Savings Plans with Reservations for optimal savings. Use SPs for base capacity and RIs for specific high-usage resources.</li>
            {% endif %}
            <li><strong>Action Plan:</strong> Start with Savings Plans for immediate flexibility, then add Reservations for high-utilization resources.</li>
        </ul>
    </div>
</div>
