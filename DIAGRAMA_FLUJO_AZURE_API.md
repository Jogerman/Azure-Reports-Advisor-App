# ๐ Diagrama de Flujo: Reportes con Azure API

## ๐ Arquitectura de Integraciรณn

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         AZURE TENANT (Cliente)                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโโโโโโ         โ
โ  โ  Azure Subscription โ โโโโโโโโโ  Azure Advisor API   โ         โ
โ  โ  (Recursos)         โ         โ  (Recomendaciones)   โ         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโโโโโโ         โ
โ            โ                              โฒ                         โ
โ            โ                              โ                         โ
โ            โผ                              โ                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ         โ
โ  โ         Service Principal (App Registration)         โ         โ
โ  โ  โข Tenant ID                                         โ         โ
โ  โ  โข Client ID                                         โ         โ
โ  โ  โข Client Secret                                     โ         โ
โ  โ  โข Permissions: Reader role                          โ         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ         โ
โ            โ                                                        โ
โโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โ API Calls (Authenticated)
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  AZURE ADVISOR REPORTS APP                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                     โ
โ  โโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโ      โ
โ  โ   Client   โโโโโโโโ    Azure     โโโโโโโโ   Reports    โ      โ
โ  โ  (Cliente) โ      โ Subscription โ      โ  (Generados) โ      โ
โ  โโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโ      โ
โ                                                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Flujo de Configuraciรณn Inicial

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    CONFIGURACIรN INICIAL                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    [INICIO]
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  1. Portal Azure   โ
โ  Crear App Reg.    โ
โโโโโโโโฌโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  2. Crear Secret   โ
โ  Guardar Value     โ
โโโโโโโโฌโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  3. Obtener IDs    โ
โ  โข Tenant ID       โ
โ  โข Client ID       โ
โ  โข Subscription ID โ
โโโโโโโโฌโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  4. Asignar Role   โ
โ  Reader โ Sub      โ
โโโโโโโโฌโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  5. App: Cliente   โ
โ  Crear/Seleccionar โ
โโโโโโโโฌโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  6. App: Azure Sub โ
โ  Ingresar Creds    โ
โโโโโโโโฌโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  7. Test Conexiรณn  โ
โ  Sync Now          โ
โโโโโโโโฌโโโโโโโโโโโโโโ
       โ
       โผ
    [LISTO]
```

---

## ๐ฏ Flujo de Generaciรณn de Reporte

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   GENERACIรN DE REPORTE                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    [Usuario]
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  1. Select Client  โ
โโโโโโโโฌโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  2. Select Source  โ
โ  โ Azure API โ     โ
โโโโโโโโฌโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโ       โโโโโโโโโโโโโโโโโโโ
โ  3. Select Azure   โ       โ  Filtros (Opt): โ
โ  Subscription      โ       โ  โข Category     โ
โโโโโโโโฌโโโโโโโโโโโโโโ       โ  โข Impact       โ
       โ                     โ  โข Resource Grp โ
       โ                     โโโโโโโโโโโโโโโโโโโ
       โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  4. Select Report  โ
โ  Type              โ
โ  โข Detailed        โ
โ  โข Executive       โ
โ  โข Cost            โ
โ  โข Security        โ
โ  โข Operations      โ
โโโโโโโโฌโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  5. Generate       โ
โ  [Button Click]    โ
โโโโโโโโฌโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         BACKEND PROCESSING              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ 1. Validate Credentials          โ  โ
โ  โ    โ                              โ  โ
โ  โ 2. Connect to Azure API          โ  โ
โ  โ    โ                              โ  โ
โ  โ 3. Fetch Advisor Recommendations โ  โ
โ  โ    โ                              โ
โ  โ 4. Process Data                  โ  โ
โ  โ    โ                              โ  โ
โ  โ 5. Apply Filters                 โ  โ
โ  โ    โ                              โ  โ
โ  โ 6. Generate Analytics            โ  โ
โ  โ    โ                              โ  โ
โ  โ 7. Render HTML Report            โ  โ
โ  โ    โ                              โ  โ
โ  โ 8. Save to Database              โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  Status: Completed โ
โโโโโโโโฌโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  6. View Report    โ
โ  โข HTML (Browser)  โ
โ  โข Generate PDF    โ
โ  โข Download        โ
โโโโโโโโโโโโโโโโโโโโโโ
       โ
       โผ
    [FIN]
```

---

## ๐ Flujo de Autenticaciรณn

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    AUTENTICACIรN AZURE API                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    [App Backend]
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  1. Retrieve Credentials from DB     โ
โ     โข tenant_id                      โ
โ     โข client_id                      โ
โ     โข client_secret (encrypted)      โ
โ     โข subscription_id                โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  2. Decrypt Client Secret            โ
โ     (Fernet encryption)              โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  3. Authenticate with Azure          โ
โ     ClientSecretCredential           โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ
       โโโโ โ Success
       โ    โ
       โ    โผ
       โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ  โ  4. Get Access Token         โ
       โ  โโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
       โ         โ
       โ         โผ
       โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ  โ  5. Call Advisor API         โ
       โ  โ  GET /recommendations        โ
       โ  โโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
       โ         โ
       โ         โผ
       โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ  โ  6. Process Response         โ
       โ  โ  Return Data                 โ
       โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ
       โโโโ โ Error
            โ
            โผ
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ  Handle Error:               โ
          โ  โข Log error                 โ
          โ  โข Update sync_status        โ
          โ  โข Return error to user      โ
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Estados del Reporte

```
โโโโโโโโโโโโ
โ PENDING  โ  โ Reporte creado, esperando procesamiento
โโโโโโฌโโโโโโ
     โ
     โผ
โโโโโโโโโโโโ
โ UPLOADED โ  โ (Solo CSV) Archivo subido
โโโโโโฌโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโ
โ PROCESSING โ  โ Conectando a Azure API / Procesando datos
โโโโโโฌโโโโโโโโ
     โ
     โโโโ โ Datos procesados exitosamente
     โ    โ
     โ    โผ
     โ  โโโโโโโโโโโโโโ
     โ  โ GENERATING โ  โ Generando HTML/PDF
     โ  โโโโโโฌโโโโโโโโ
     โ       โ
     โ       โผ
     โ  โโโโโโโโโโโโโ
     โ  โ COMPLETED โ  โ Reporte listo
     โ  โโโโโโโโโโโโโ
     โ
     โโโโ โ Error en el proceso
          โ
          โผ
        โโโโโโโโโโ
        โ FAILED โ  โ Error, revisar logs
        โโโโโโโโโโ
```

---

## ๐ Ciclo de Vida de Azure Subscription

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 AZURE SUBSCRIPTION LIFECYCLE                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    [Crear]
       โ
       โผ
โโโโโโโโโโโโโโโโโโโ
โ NEVER_SYNCED    โ  โ Estado inicial
โ sync_status     โ
โโโโโโฌโโโโโโโโโโโโโ
     โ
     โ [Sync Now / Primer reporte]
     โ
     โผ
โโโโโโโโโโโโโโโโโโโ
โ Testing...      โ  โ Probando conexiรณn
โโโโโโฌโโโโโโโโโโโโโ
     โ
     โโโโ โ Credenciales vรกlidas
     โ    โ
     โ    โผ
     โ  โโโโโโโโโโโโโโโโโโโ
     โ  โ SUCCESS         โ  โ Sincronizaciรณn exitosa
     โ  โ last_sync_at    โ     (actualiza timestamp)
     โ  โโโโโโฌโโโโโโโโโโโโโ
     โ       โ
     โ       โ [Sync periรณdico / Nuevos reportes]
     โ       โ
     โ       โโโโ โ Sync OK
     โ       โ    โโโโ [Mantiene SUCCESS]
     โ       โ
     โ       โโโโ โ Error temporal
     โ            โโโโ [Cambia a FAILED]
     โ
     โโโโ โ Credenciales invรกlidas / Error
          โ
          โผ
        โโโโโโโโโโโโโโโโโโโ
        โ FAILED          โ  โ Error de sincronizaciรณn
        โ sync_error_msg  โ     (guarda mensaje de error)
        โโโโโโฌโโโโโโโโโโโโโ
             โ
             โ [Update credentials / Retry]
             โ
             โโโโ [Vuelve a Testing...]
```

---

## ๐๏ธ Arquitectura de Componentes

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         FRONTEND (React)                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ        โ
โ  โ  ClientsPage     โ     โ  ClientDetailPage            โ        โ
โ  โ                  โโโโโโโ  โข Client Info               โ        โ
โ  โ  โข List Clients  โ     โ  โข Azure Subscriptions       โ        โ
โ  โ  โข Add Client    โ     โ    - Add/Edit/Delete         โ        โ
โ  โโโโโโโโโโโโโโโโโโโโ     โ    - Sync Now                โ        โ
โ                           โ  โข Reports History           โ        โ
โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ        โ
โ                                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ       โ
โ  โ  ReportsPage                                           โ       โ
โ  โ  1. Select Client                                      โ       โ
โ  โ  2. Select Data Source (CSV / Azure API)              โ       โ
โ  โ  3. Select Azure Subscription (filtered by client)     โ       โ
โ  โ  4. Select Report Type                                 โ       โ
โ  โ  5. Generate                                           โ       โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ       โ
โ                                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ       โ
โ  โ  ReportList                                            โ       โ
โ  โ  โข View Reports                                        โ       โ
โ  โ  โข Download PDF                                        โ       โ
โ  โ  โข View Analytics                                      โ       โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ       โ
โ                                                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โ REST API Calls
                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      BACKEND (Django)                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ  API Endpoints     โ     โ  Models                      โ      โ
โ  โ                    โ     โ                              โ      โ
โ  โ  /clients/         โโโโโโโ  Client                      โ      โ
โ  โ  /azure-subs/      โ     โ  โโ azure_subscriptions      โ      โ
โ  โ  /reports/         โ     โ     (ForeignKey)             โ      โ
โ  โ                    โ     โ                              โ      โ
โ  โ                    โ     โ  AzureSubscription           โ      โ
โ  โ                    โ     โ  โข client (FK)               โ      โ
โ  โ                    โ     โ  โข credentials (encrypted)   โ      โ
โ  โ                    โ     โ  โข sync_status               โ      โ
โ  โ                    โ     โ                              โ      โ
โ  โ                    โ     โ  Report                      โ      โ
โ  โ                    โ     โ  โข client (FK)               โ      โ
โ  โ                    โ     โ  โข azure_subscription (FK)   โ      โ
โ  โ                    โ     โ  โข data_source               โ      โ
โ  โ                    โ     โ  โข analysis_data (JSON)      โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โ  Services / Business Logic                              โ      โ
โ  โ  โข AzureAdvisorService                                  โ      โ
โ  โ    - authenticate()                                     โ      โ
โ  โ    - fetch_recommendations()                            โ      โ
โ  โ  โข ReportGeneratorService                               โ      โ
โ  โ    - process_data()                                     โ      โ
โ  โ    - generate_html()                                    โ      โ
โ  โ    - generate_pdf()                                     โ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ                                                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โ Async Tasks
                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     CELERY WORKERS                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                     โ
โ  โข process_csv_report_task()                                       โ
โ  โข generate_report_from_azure_api()                                โ
โ  โข generate_html_pdf_task()                                        โ
โ  โข test_azure_connection()                                         โ
โ  โข sync_azure_statistics()                                         โ
โ                                                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Sincronizaciรณn Automรกtica

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      CELERY BEAT (Scheduler)                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โ Every 6 hours
                             โ
                             โผ
                โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ  sync_all_azure_subs()    โ
                โโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
                          โ
                          โ For each active subscription
                          โ
                          โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  1. Get Active Azure Subscriptions      โ
        โ     WHERE is_active = True              โ
        โโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  2. For Each Subscription:              โ
        โ     โข Authenticate                      โ
        โ     โข Fetch Latest Recommendations      โ
        โ     โข Update Statistics Cache           โ
        โ     โข Update sync_status                โ
        โ     โข Update last_sync_at               โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

**Versiรณn**: 1.0
**รltima actualizaciรณn**: 20 de noviembre de 2025
**Aplicaciรณn**: Azure Advisor Reports v2.0.15
